<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hotplate API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
     <link rel="stylesheet" href="/global/header.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">
 
      <!-- HEADER -->
      <div id="header_wrap" class="outer">
  
          <div class="main_menu">
               <span><a href="/">Home</a></span>
               <span><a href="/guide.html">Guide</a></span>
               <span><a href="/serverAPI/index.html">Server API</a></span>
               <span><a href="/clientAPI/index.html">Client API</a></span>
          </div>
  
          <header class="inner">
            <a id="forkme_banner" href="https://github.com/mercmobily/hotplate">View on GitHub</a>
  
              
            <h1 id="project_title">Hotplate server API</h1>
            <h2 id="project_tagline">Framework to create multi-homed SaaS with NodeJs, Express</h2>
  
              <section id="downloads">
 
                <a class="zip_download_link" href="https://github.com/mercmobily/hotplate/zipball/master">Download this project as a .zip file</a>
                <a class="tar_download_link" href="https://github.com/mercmobily/hotplate/tarball/master">Download this project as a tar.gz file</a>
              </section>
          </header>
      </div>



<div id="doc">

    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html">Hotplate&#x27;s API: hotplate/node_modules/hotCoreClientFiles/lib/hotCoreClientFiles.js</a></h1>
            <!--<h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">Hotplate&#x27;s API: hotplate/node_modules/hotCoreClientFiles/lib/hotCoreClientFiles.js</a></h1> -->
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.2.1</em>
        </div>
    </div>

    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/hotCoreAuth.html">hotCoreAuth</a>
                            </li>
                            <li><a href="../modules/hotCoreClientFiles.html">hotCoreClientFiles</a>
                            </li>
                            <li><a href="../modules/hotCoreMultiHome.html">hotCoreMultiHome</a>
                            </li>
                            <li><a href="../modules/hotCoreTransport.html">hotCoreTransport</a>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/hotCoreAuth.html">hotCoreAuth</a></li>
                            <li><a href="../classes/hotCoreAuth.facebook.html">hotCoreAuth.facebook</a></li>
                            <li><a href="../classes/hotCoreClientFiles.html">hotCoreClientFiles</a></li>
                            <li><a href="../classes/hotCoreMultiHome.html">hotCoreMultiHome</a></li>
                            <li><a href="../classes/hotCoreTransport.html">hotCoreTransport</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>hotplate/<ul><li>node_modules/<ul><li>hotCoreAuth/<ul><li>lib/<ul><li>auth/<ul><li><a href="../files/hotplate_node_modules_hotCoreAuth_lib_auth_facebook.js.html">facebook.js</a></li></ul></li><li><a href="../files/hotplate_node_modules_hotCoreAuth_lib_hotCoreAuth.js.html">hotCoreAuth.js</a></li></ul></li></ul></li><li>hotCoreClientFiles/<ul><li>lib/<ul><li><a href="../files/hotplate_node_modules_hotCoreClientFiles_lib_hotCoreClientFiles.js.html">hotCoreClientFiles.js</a></li></ul></li></ul></li><li>hotCoreMultiHome/<ul><li>lib/<ul><li><a href="../files/hotplate_node_modules_hotCoreMultiHome_lib_hotCoreMultiHome.js.html">hotCoreMultiHome.js</a></li></ul></li></ul></li><li>hotCorePage/<ul><li>lib/<ul><li><a href="../files/hotplate_node_modules_hotCorePage_lib_Vars.js.html">Vars.js</a></li></ul></li></ul></li><li>hotCoreTransport/<ul><li>lib/<ul><li><a href="../files/hotplate_node_modules_hotCoreTransport_lib_hotCoreTransport.js.html">hotCoreTransport.js</a></li></ul></li></ul></li></ul></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>hotplate/node_modules/hotCoreClientFiles/lib/hotCoreClientFiles.js</h4>

<pre class="code prettyprint linenums">
&quot;use strict&quot;;


/*!
 * Module dependencies.
 */

var dummy
  , hotplate = require(&#x27;hotplate&#x27;)
  , path = require(&#x27;path&#x27;)
  , send = require(&#x27;send&#x27;)
  , e = require(&#x27;allhttperrors&#x27;)
;


hotplate.config.set(&#x27;hotCoreClientFiles.renderExtensions&#x27;,  { &#x27;.jade&#x27;: true } );

/**
  Module to handle the delivery of files made available by modules

  @module hotCoreClientFiles
  @main hotCoreClientFiles
  @class hotCoreClientFiles
*/

/**
  The list of local paths that will be handles by the module

  @attribute localLocations
*/


/**
  Call the hook &#x60;clientPaths&#x60;, and store the results
  in &#x60;localLocations&#x60;

  @event init
*/
var getLocalLocations = hotplate.cachable( function( done ){

  var moduleName;
  var localLocations = {};

  hotplate.hotEvents.emitCollect( &#x27;clientPath&#x27;, function( err, results ){
    results.forEach( function( element ) {
      localLocations[ element.module ] = element.result;
    });

    done( null, localLocations );
  });
});


var getRenderList = hotplate.cachable( function( done ){

  var moduleName;
  var renderList = {};

  hotplate.hotEvents.emitCollect( &#x27;clientPathRender&#x27;, function( err, results ){
    results.forEach( function( element ) {
      moduleName = element.module;

      element.result.forEach( function( toRender ){
        if( ! renderList[ moduleName ] ) renderList[ moduleName ] = {};
        for( var k in toRender ){
          renderList[ moduleName ][ k ] = toRender[ k ];
        }
      });
    });

    done( null, renderList );
  });
});


/**
  Returns a function that will serve files that are set as
  public by other modules by implementing the &#x60;clientPaths&#x60; hook

  This function is a mixture of:
    * express/node_modules/connect/lib/middleware
    * express/lib/application.js#app.render

  @method serve
  @param options 
*/
exports.serve = function( app, options ){

  options = options || {};

  // Make up the regular expression to check if the URL requested in
  // one of the URLs monitored by the module
  var moduleFilesPrefixRegExp = new RegExp(&#x27;^&#x27; + hotplate.config.get(&#x27;hotplate.moduleFilesPrefix&#x27;) + &#x27;/(.*?)/(.*)&#x27;);

  // Return the actual route
  return function(req, res, next) {

    // If there is a match between the request and the
    // expected sub-url...
    var  match = req.path.match( moduleFilesPrefixRegExp );

    getLocalLocations( function( err, localLocations ){
      if( err ) return next( err );

      getRenderList( function( err, renderList ){
        if( err ) return next( err );
      
        if( match &amp;&amp; localLocations[ match[1] ] ){
    
          // Create the variable names
          var moduleName = match[1];
          var fileLocation = match[2];
    
          // Get the &quot;local&quot; variable for that module
          var localDir = localLocations[ moduleName ];
    
          // At this point, if:
          //  - req.path      is /hotPlateDir/testingModule/css/one.css
          //  - moduleFilesPrefix is /hotPlateDir 
          //  
          // Then:
          //  - moduleName   would be  testingModule
          //  - localDir     would be  /home/www/program/node_modules/testingModule/public_files/
          //  - fileLocation would be  css/one.css 
  
          // CASE #1: File needs to be rendered!

          if( renderList[ moduleName ] &amp;&amp; typeof( renderList[ moduleName ][ fileLocation ] ) === &#x27;object&#x27; ){

            var renderOpts = renderList[ moduleName ][ fileLocation ];
 
            var opts = {};

            // Copy over app&#x27;s locals and render opts (taken from renderList)
            for( var key in app.locals ) opts[ key ] = app.locals[ key ];
            for( var key in renderOpts ) opts[ key ] = renderOpts[ key ];

            opts.name = new Date();

            // Make up the view
            var view = new (app.get(&#x27;view&#x27;))(fileLocation, {
              defaultEngine: app.get(&#x27;view engine&#x27;),
              root: localDir,
              engines: app.engines
            });

            // If the view was found (path is there), then render it
            // using the right options
            if( ! view.path ){
              next( new e.NotFoundError() );
            } else {
              view.render( opts, function( err, html ){
                if( err ){
                  next( err );
                } else {
                  res.send( html );
                }
              });

            }

          // CASE #2: No rendering required, send and that&#x27;s it
          } else {

            var error = function error( err ) {
              if( 404 == err.status) return next();
              next(err);
            }
 
            // Send it!
            send(req, fileLocation, {  maxage: options.maxAge || 0, root: localDir } )
              .on(&#x27;error&#x27;, error )
              .pipe( res );
          } 
          
        } else {
          return next();
        }

      })
  
    });





  }

};


</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
