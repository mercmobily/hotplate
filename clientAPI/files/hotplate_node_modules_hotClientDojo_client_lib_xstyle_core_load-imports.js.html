<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hotplate API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
     <link rel="stylesheet" href="/global/header.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">
 
      <!-- HEADER -->
      <div id="header_wrap" class="outer">
  
          <div class="main_menu">
               <span><a href="/">Home</a></span>
               <span><a href="/guide.html">Guide</a></span>
               <span><a href="/serverAPI/index.html">Server API</a></span>
               <span><a href="/clientAPI/index.html">Client API</a></span>
          </div>
  
          <header class="inner">
            <a id="forkme_banner" href="https://github.com/mercmobily/hotplate">View on GitHub</a>
  
              
            <h1 id="project_title">Hotplate server API</h1>
            <h2 id="project_tagline">Framework to create multi-homed SaaS with NodeJs, Express</h2>
  
              <section id="downloads">
 
                <a class="zip_download_link" href="https://github.com/mercmobily/hotplate/zipball/master">Download this project as a .zip file</a>
                <a class="tar_download_link" href="https://github.com/mercmobily/hotplate/tarball/master">Download this project as a tar.gz file</a>
              </section>
          </header>
      </div>



<div id="doc">

    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html">undefined: hotplate/node_modules/hotClientDojo/client/lib/xstyle/core/load-imports.js</a></h1>
            <!--<h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">undefined: hotplate/node_modules/hotClientDojo/client/lib/xstyle/core/load-imports.js</a></h1> -->
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>

    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>hotplate/<ul><li>node_modules/<ul><li>hotClientDojo/<ul><li>client/<ul><li>lib/<ul><li>dgrid/<ul><li>demos/<ul><li>laboratory/<ul><li>data/<ul><li><a href="../files/hotplate_node_modules_hotClientDojo_client_lib_dgrid_demos_laboratory_data_features.js.html">features.js</a></li></ul></li><li>util/<ul><li><a href="../files/hotplate_node_modules_hotClientDojo_client_lib_dgrid_demos_laboratory_util_toJavaScript.js.html">toJavaScript.js</a></li></ul></li></ul></li></ul></li></ul></li><li>dstore/<ul><li>tests/<ul><li><a href="../files/hotplate_node_modules_hotClientDojo_client_lib_dstore_tests_sorting.js.html">sorting.js</a></li></ul></li></ul></li><li>xstyle/<ul><li>core/<ul><li><a href="../files/hotplate_node_modules_hotClientDojo_client_lib_xstyle_core_load-imports.js.html">load-imports.js</a></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>hotplate/node_modules/hotClientDojo/client/lib/xstyle/core/load-imports.js</h4>

<pre class="code prettyprint linenums">
// summary:
//		This script scans for stylesheets and flattens imports in IE (to fix the deep import bug),
//		and provides loading of the text of any sheets. This is intended to only be loaded as needed
// 		for development, ideally stylesheets should be flattened and inlined for finished/production
// 		applications, and this module won&#x27;t be loaded.  
define(&#x27;xstyle/core/load-imports&#x27;, [], function(){
	var insertedSheets = {},
		features = {
			// essentially test to see if it is IE, inaccurate marker, maybe should use dom-addeventlistener?
			&#x27;dom-deep-import&#x27;: !document.createStyleSheet 
		};
	function has (feature) {
		return features[feature];
	}
	// load any plugin modules when done parsing
	function load(link, callback){
		var sheet = link.sheet || link.styleSheet;
		
		var loadingCount = 1;
		
		function finishedModule(){
			if(!--loadingCount){
				aggregateSource(sheet);
				callback &amp;&amp; callback(sheet);
			}
		}
		function aggregateSource(sheet){
			var source = &#x27;&#x27;;
			var importRules = !sheet.disabled &amp;&amp; (sheet.imports || sheet.rules || sheet.cssRules);
			
			for(var i = 0; i &lt; importRules.length; i++){										
				var rule = importRules[i];
				if(rule.href){
					source += aggregateSource(rule.styleSheet || rule);
				}
			}
			return (sheet.source = source + sheet.localSource);
		}
		if(false &amp;&amp; !has(&#x27;dom-deep-import&#x27;)){
			// in IE, so we flatten the imports due to IE&#x27;s lack of support for deeply nested @imports
			// and fix the computation of URLs (IE calculates them wrong)
			var computeImportUrls = function(sheet, baseUrl){
				var computedUrls = [];
				// IE miscalculates .href properties, so we calculate them by parsing
				sheet.cssText.replace(/@import url\( ([^ ]+) \)/g, function(t, url){
						// we have to actually parse the cssText because IE&#x27;s href property is totally wrong
						computedUrls.push(absoluteUrl(baseUrl, url));
					});
				return computedUrls;
			},
			flattenImports = function(){
				// IE doesn&#x27;t support deeply nested @imports, so we flatten them.
				//	IE needs imports rearranged and then to go through on a later turn.
				// This function is a big pile of IE fixes
				var flatteningOccurred, sheet = link.styleSheet;
				if(sheet.processed){
					return;
				}
				var sheetHref = sheet.correctHref = absoluteUrl(location.toString(), sheet.href);
				if(!sheet.computedUrls){
					// we have to do in a pre-loop or else IE&#x27;s messes up on it&#x27;s ownerRule&#x27;s order
					sheet.computedUrls = computeImportUrls(sheet, sheetHref);
				}
				for(var i = 0; i &lt; sheet.imports.length; i++){
					var importedSheet = sheet.imports[i];
					if(!importedSheet.cssText &amp;&amp;
							// empty means it is not loaded yet, try again later
							!importedSheet.imports.length){
						setTimeout(flattenImports, 50);
						return;
					}
				//	importedSheet.loaded = true;
					var correctHref = importedSheet.correctHref = sheet.computedUrls[i];
					
					var childHrefs = computeImportUrls(importedSheet, correctHref);
					// Deep in an IE stylesheet
					for(var j = 0; j &lt; importedSheet.imports.length; j++){
						// TODO: Think we can just stay in place and remove
						var subImport = importedSheet.imports[j];
						if(!subImport.correctHref){
							flatteningOccurred = true;
							link.onload = flattenImports;
							var childHref = childHrefs[j] || importedSheet.href;
							sheet.computedUrls.splice(i, 0, childHref);
							try{
								sheet.addImport(childHref, i++);
							}catch(e){
								// this will fail if there are too many imports
							}
							subImport.correctHref = childHref; 
						}
					}
				}
				if(flatteningOccurred){
					setTimeout(flattenImports, 50);
				}else{
					sheet.processed = true;
					loadOnce(sheet);
				}
			};
			flattenImports();
			return finishedModule();
		}
		
		loadOnce(sheet);
		finishedModule();
		function loadOnce(sheet, baseUrl){
			// This function is responsible for implementing the @import once
			// semantics, such extra @imports that resolve to the same
			// CSS file are eliminated, and only the first one is kept
			
			var href = absoluteUrl(baseUrl, sheet.correctHref || sheet.href);
			// do normalization
			// TODO: remove this normalization, it is done in xstyle 
			if(!sheet.addRule){
				// only FF doesn&#x27;t have this
				sheet.addRule = function(selector, style, index){
					return this.insertRule(selector + &#x27;{&#x27; + style + &#x27;}&#x27;, index &gt;= 0 ? index : this.cssRules.length);
				};
			}
			if(!sheet.deleteRule){
				sheet.deleteRule = sheet.removeRule;
			}
			var existingSheet = href &amp;&amp; insertedSheets[href]; 
			if(existingSheet){
				var sheetToDelete;
				if(existingSheet != sheet){
					var parentStyleSheet = sheet.parentStyleSheet;
					var existingElement = existingSheet.ownerElement;
					if(existingElement.compareDocumentPosition ? 
							existingElement.compareDocumentPosition(link) != 2 :
							existingElement.sourceIndex &lt;= link.sourceIndex){
						// this new sheet is after (or current), so we kill this one
						sheetToDelete = sheet;
					}else{
						// the other sheet is after, so delete it
						sheetToDelete = existingSheet;
						existingSheet = insertedSheets[href] = sheet;
					}
					// need to delegate to sheet that we are going to preserve
					// TODO: might need to use a queue to store changes and delegate changes that
					// have already taken place on the sheetToDelete
					sheetToDelete.addRule = function(c,s,i){
						existingSheet.addRule(c,s,i &gt; -1 ? i : -1);
					};
					sheetToDelete.deleteRule = function(i){
						existingSheet.deleteRule(i);
					};
					var owner = sheetToDelete.ownerNode || !parentStyleSheet &amp;&amp; sheetToDelete.owningElement;
					if(owner){
						// it is top level &lt;link&gt;, remove the node (disabling doesn&#x27;t work properly in IE,
						// but node removal works everywhere)
						owner.parentNode.removeChild(owner); 
					}else{
						// disabling is the only way to remove an imported stylesheet in firefox; it doesn&#x27;t
						// work in IE and WebKit
						sheetToDelete.disabled = true; // this works in Opera
						if(&#x27;cssText&#x27; in sheetToDelete){
							sheetToDelete.cssText =&#x27;&#x27;; // this works in IE
						}else{
							// removing the rule is only way to remove an imported stylesheet in WebKit
							owner = sheetToDelete.ownerRule;
							if(owner){
								try{
									parentStyleSheet = owner.parentStyleSheet;
									var parentRules = parentStyleSheet.cssRules;
									for(var i = 0; i &lt; parentRules.length; i++){
										// find the index of the owner rule that we want to delete
										if(parentRules[i] == owner){
											parentStyleSheet.deleteRule(i);
											break;
										}
									}
									return true;
								}catch(e){
									// opera fails on deleteRule for imports, but the disabled works, so we can continue
									console.log(e);
								}
							}
						}
					}
				}
			}
			if(sheetToDelete != sheet){
				if(href){
					if(/no-xstyle$/.test(href)){
						sheet.localSource = &#x27;&#x27;;
						return;
					}else{
						// record the stylesheet in our hash
						insertedSheets[href] = sheet;
						sheet.ownerElement = link;
						var sourceSheet = sheet;
						loadingCount++;
						fetchText(href, function(text){
							sourceSheet.localSource = text;
							finishedModule();
						}, function(){
							sourceSheet.localSource = &#x27;&#x27;;
							finishedModule();
						});
					}
				}else{
					sheet.localSource = link.innerHTML;
				}
				var cssRules = sheet.rules || sheet.cssRules || [];
				for(var i = 0; i &lt; cssRules.length; i++){
					var rule = cssRules[i];
					if(rule.selectorText &amp;&amp; rule.selectorText.substring(0,2) == &#x27;x-&#x27;){
						sheet.needsParsing = true;
					}
				}
				
				// now recurse into @import&#x27;s to check to make sure each of those is only loaded once 
				var importRules = sheet.imports || cssRules;
				
				for(var i = 0; i &lt; importRules.length; i++){										
					var rule = importRules[i];
					if(rule.href){
						// it&#x27;s an import (for non-IE browsers we are looking at all rules,
						// and need to exclude non-import rules
						var childSheet = rule.styleSheet || rule;
						if(loadOnce(childSheet, href)){
							i--; // deleted, so go back in index
						}
						if(childSheet.needsParsing){
							sheet.needsParsing = true;
						}
					}
				}
			}
			// sheetToDelete = null; // Don&#x27;t entrap IE memory
		}
	}
	function absoluteUrl(base, url) {
		if(!url || url.indexOf(&#x27;:&#x27;) &gt; 0 || url.charAt(0) == &#x27;/&#x27;){
			return url;
		}
		// in IE we do this trick to get the absolute URL
		var lastUrl;
		url = ((base || location.toString()).replace(/[^\/]*$/,&#x27;&#x27;) + url).replace(/\/\.\//g,&#x27;/&#x27;);
		while(lastUrl != url){
			lastUrl = url;
			url = url.replace(/\/[^\/]+\/\.\.\//g, &#x27;/&#x27;);
		}
		return url;
	}
	return load;
	/***** xhr *****/

	var progIds = [&#x27;Msxml2.XMLHTTP&#x27;, &#x27;Microsoft.XMLHTTP&#x27;, &#x27;Msxml2.XMLHTTP.4.0&#x27;];

	function xhr () {
		if (typeof XMLHttpRequest !== &#x27;undefined&#x27;) {
			// rewrite the getXhr method to always return the native implementation
			xhr = function () { return new XMLHttpRequest(); };
		}
		else {
			// keep trying progIds until we find the correct one, then rewrite the getXhr method
			// to always return that one.
			var noXhr = xhr = function () {
					throw new Error(&#x27;getXhr(): XMLHttpRequest not available&#x27;);
				};
			while (progIds.length &gt; 0 &amp;&amp; xhr === noXhr) (function (id) {
				try {
					new ActiveXObject(id);
					xhr = function () { return new ActiveXObject(id); };
				}
				catch (ex) {}
			}(progIds.shift()));
		}
		return xhr();
	}

	function fetchText (url, callback, errback) {
		var x = xhr();
		x.open(&#x27;GET&#x27;, url, true);
		x.onreadystatechange = function(){
			if (x.readyState === 4) {
				if (x.status &lt; 400) {
					callback(x.responseText);
				}
				else {
					errback(new Error(&#x27;fetchText() failed. status: &#x27; + x.statusText));
				}
			}
		};
		x.send(null);
	}
	
});

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
